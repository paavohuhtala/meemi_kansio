name: Deploy

on:
  release:
    types: [released]

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Extract image tag from release tag
        id: tag
        run: echo "image_tag=${GITHUB_REF_NAME#build-}" >> "$GITHUB_OUTPUT"

      - name: Install OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: "1.9"

      - name: Initialize OpenTofu
        working-directory: infra
        run: |
          tofu init \
            -backend-config="access_key=${{ secrets.SCW_ACCESS_KEY }}" \
            -backend-config="secret_key=${{ secrets.SCW_SECRET_KEY }}"

      - name: Apply infrastructure
        working-directory: infra
        env:
          SCW_ACCESS_KEY: ${{ secrets.SCW_ACCESS_KEY }}
          SCW_SECRET_KEY: ${{ secrets.SCW_SECRET_KEY }}
          TF_VAR_scaleway_project_id: ${{ secrets.SCW_PROJECT_ID }}
          TF_VAR_image_tag: ${{ steps.tag.outputs.image_tag }}
          TF_VAR_database_url: ${{ secrets.DATABASE_URL }}
          TF_VAR_jwt_secret: ${{ secrets.JWT_SECRET }}
          TF_VAR_s3_access_key_id: ${{ secrets.S3_ACCESS_KEY_ID }}
          TF_VAR_s3_secret_access_key: ${{ secrets.S3_SECRET_ACCESS_KEY }}
          TF_VAR_route53_zone_id: ${{ secrets.ROUTE53_ZONE_ID }}
          TF_VAR_aws_access_key_id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          TF_VAR_aws_secret_access_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        run: tofu apply -auto-approve

  cleanup:
    runs-on: ubuntu-latest
    needs: [deploy]
    permissions:
      contents: write
    steps:
      - name: Delete old pre-releases
        env:
          GH_TOKEN: ${{ github.token }}
          CURRENT_TAG: ${{ github.event.release.tag_name }}
        run: |
          gh release list --repo "$GITHUB_REPOSITORY" --json tagName,isPrerelease \
            --jq '.[] | select(.isPrerelease) | select(.tagName != env.CURRENT_TAG) | .tagName' \
            | while read -r tag; do
                gh release delete "$tag" --repo "$GITHUB_REPOSITORY" --yes --cleanup-tag
              done

  cleanup-registry:
    runs-on: ubuntu-latest
    needs: [deploy]
    environment: production
    steps:
      - name: Delete old container image tags
        env:
          SCW_SECRET_KEY: ${{ secrets.SCW_SECRET_KEY }}
          SCW_REGISTRY_NAMESPACE: ${{ secrets.SCW_REGISTRY_NAMESPACE }}
          DEPLOYED_TAG: ${{ github.event.release.tag_name }}
        run: |
          IMAGE_TAG="${DEPLOYED_TAG#build-}"
          API="https://api.scaleway.com/registry/v1/regions/fr-par"

          NS_ID=$(curl -sf -H "x-auth-token: $SCW_SECRET_KEY" \
            "$API/namespaces" \
            | jq -r ".namespaces[] | select(.name == \"$SCW_REGISTRY_NAMESPACE\") | .id")

          IMG_ID=$(curl -sf -H "x-auth-token: $SCW_SECRET_KEY" \
            "$API/images?namespace_id=$NS_ID&name=meemit-backend" \
            | jq -r '.images[0].id')

          curl -sf -H "x-auth-token: $SCW_SECRET_KEY" \
            "$API/images/$IMG_ID/tags?page_size=100" \
            | jq -r ".tags[] | select(.name != \"$IMAGE_TAG\" and .name != \"latest\" and .name != \"buildcache\") | .id + \" \" + .name" \
            | while read -r tag_id tag_name; do
                echo "Deleting tag: $tag_name"
                curl -sf -X DELETE -H "x-auth-token: $SCW_SECRET_KEY" \
                  "$API/tags/$tag_id"
              done

          echo "Registry cleanup complete"
